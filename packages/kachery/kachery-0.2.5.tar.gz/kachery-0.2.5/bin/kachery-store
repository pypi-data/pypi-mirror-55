#!/usr/bin/env python

import os
import sys
import argparse
import time
import kachery as ka

def main():
    old_stdout = sys.stdout
    sys.stdout = sys.stderr

    parser = argparse.ArgumentParser(description='Store a file in the local hash cache and optionally upload to a remote kachery database.')
    parser.add_argument('path', help='Path to local file or directory')
    parser.add_argument('--algorithm', '-a', help='The hash algorithm to use: sha1 or md5', default='sha1')
    parser.add_argument('--upload', '-u', help='Whether to store the data remotely in addition to locally', required=False, action='store_true')
    parser.add_argument('--upload-only', '-uo', help='Whether to store the data remotely but not locally', required=False, action='store_true')
    parser.add_argument('--url', help='The URL of the kachery database server to upload to (or use KACHERY_URL environment variable and the --upload (-u) flag)', required=False, default=None)
    parser.add_argument('--channel', '-c', help='The channel of the kachery database server to upload to (or use KACHERY_CHANNEL environment variable)', required=False, default=None)
    parser.add_argument('--password', '-p', help='The password of the kachery database server to upload to (or use KACHERY_PASSWORD environment variable)', required=False, default=None)
    parser.add_argument('--git-annex-mode', help='Act smart with git-annex repos', required=False, action='store_true')
    

    args = parser.parse_args()
    path = args.path

    ka.set_config(
        algorithm=args.algorithm
    )
    if args.upload or args.upload_only:
        url=args.url or os.getenv('KACHERY_URL')
        channel=args.channel or os.getenv('KACHERY_CHANNEL')
        password=args.password or os.getenv('KACHERY_PASSWORD')
        if not url:
            raise Exception('You must specify a URL either using the --url flag or by setting the KACHERY_URL environment variable')
        if not channel:
            raise Exception('You must specify a channel either using the --channel (-c) flag or by setting the KACHERY_CHANNEL environment variable')
        if not password:
            raise Exception('You must specify a password either using the --password (-p) flag or by setting the KACHERY_PASSWORD environment variable')
        ka.set_config(
            url=url,
            channel=channel,
            password=password,
            upload=args.upload or False,
            upload_only=args.upload_only or False
        )
    elif args.url or args.channel or args.password:
        raise Exception('You must specify either --upload (-u) or --upload-only (-uo) when using these options.')
    if os.path.isfile(path):
        address = ka.store_file(path)
    elif os.path.isdir(path):
        address = ka.store_dir(path, git_annex_mode=args.git_annex_mode)
    else:
        raise Exception('Not a file or directory: {}'.format(path))

    if not address:
        raise Exception('Error storing file.')

    sys.stdout = old_stdout

    print(address)

if __name__ == "__main__":
    main()
