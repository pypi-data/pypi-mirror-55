
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Router Example scripts &#8212; pysap 0.1.17 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Development" href="../dev/index.html" />
    <link rel="prev" title="Message Server Example scripts" href="message_server.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="router-example-scripts">
<h1>Router Example scripts<a class="headerlink" href="#router-example-scripts" title="Permalink to this headline">¶</a></h1>
<div class="section" id="router-admin">
<h2><code class="docutils literal notranslate"><span class="pre">router_admin</span></code><a class="headerlink" href="#router-admin" title="Permalink to this headline">¶</a></h2>
<p>This example script connects to a SAP Router instance and allows to perform administrative tasks.
The commands available and their syntax is similar to the one found on the <code class="docutils literal notranslate"><span class="pre">saprouter</span></code> program.
The operation codes and commands are documented in the SAP’s help pages for the SAP Router.
In addition to those commands found in the <code class="docutils literal notranslate"><span class="pre">saprouter</span></code> program, the scripts includes undocumented
operations codes.</p>
<p>In order for administrative tasks to be run, the script need to be run from the same system where the
SAP Router instance is running (connections identified as “local” by the Network Interface (<code class="docutils literal notranslate"><span class="pre">NI</span></code>)
protocol), or the SAP Router needs to be configured as to allow remote connections to the SAP Router
port. An example of such a routing table to allow this access is as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>P * 127.0.0.1 3299
</pre></div>
</div>
<p>The undocumented commands implemented by the script are the following ones:</p>
<ul class="simple">
<li><dl class="first docutils">
<dt><code class="docutils literal notranslate"><span class="pre">set-peer-trace</span></code>:</dt>
<dd>Takes an address mask as an argument and sets the tracing of peers matching that address mask.</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal notranslate"><span class="pre">clear-peer-trace</span></code>:</dt>
<dd>Takes an address mask as an argument and clears the tracing of peers matching that address mask.</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal notranslate"><span class="pre">trace-connection</span></code>:</dt>
<dd>Takes a client identifier as an argument and enables a trace for that connection. The list of
clients being traced can be observed using the <code class="docutils literal notranslate"><span class="pre">router-info</span></code> commands.</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="router-fingerprint">
<h2><code class="docutils literal notranslate"><span class="pre">router_fingerprint</span></code><a class="headerlink" href="#router-fingerprint" title="Permalink to this headline">¶</a></h2>
<p>It was found out that SAP Router instances include some information in error messages when
processing certain type of malformed packets or when certain fault situations are reached. The
information contained in those error messages includes details such as the SAP Router’s release
number, name of the source code file where the error is thrown, and in some cases the code line
where the error was identified. As the source file numbers are frequently changing between one
version of the program an another, it can be very precise as to potentially identify build
numbers and pinpoint particular version numbers. This information can be valuable as to determine
potential security risk in case of running old and potentially vulnerable versions of the SAP
Router service.</p>
<p>This example script is an experimental attempt at performing remote SAP Router version
fingerprinting by triggering those error conditions and matching the information provided in the
error messages with a previously generated database. A fingerprint database is maintained and
located in the <code class="docutils literal notranslate"><span class="pre">examples/router_fingerprints.json</span></code> file.</p>
<p>The following is an example result of running the script against a version of SAP Router already
in the database:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python router_fingerprint.py -d &lt;hostname&gt;
[*] Loading fingerprint database
[*] Trying to fingerprint version using 13 packets
[*] (1/13) Fingerprint for packet &#39;No route one entry&#39;
[*] (1/13) Fingerprint for packet &#39;No route one entry&#39; matched !
[*] (2/13) Fingerprint for packet &#39;Timeout&#39;
[*] (2/13) Fingerprint for packet &#39;Timeout&#39; matched !
..
..
[*] (13/13) Fingerprint for packet &#39;No route invalid length&#39; matched !

[*] Matched fingerprints (13/13):
[+] Request: No route one entry
[+] Request: Timeout
[+] Request: No route
[+] Request: Empty route invalid offset
[+] Request: Non existent domain old version
[+] Request: Valid domain invalid service
[+] Request: Invalid control opcode
[+] Request: Network packet too big
[+] Request: Empty route invalid length
[+] Request: Non existent domain
[+] Request: Empty route valid length
[+] Request: Empty route null offset
[+] Request: No route invalid length

[*] Probable versions (1):
[*] Hits: 13 Version: version: &quot;40&quot; release: &quot;749&quot; patch_number: &quot;200&quot; source_id: &quot;0.200&quot; update_level: &quot;0&quot; platform: &quot;linux-x86-64&quot; submitted_by: &quot;mgallo@secureauth.com&quot;
</pre></div>
</div>
<p>As can be observed, by matching the information in the error message with the fingerprint database
it’s possible to narrow down the version to a build number.</p>
<p>The following is an example result of running the script against a version of SAP Router that is
not found in the database:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ./router_fingerprint.py -d &lt;hostname&gt;
[*] Loading fingerprint database
[*] Trying to fingerprint version using 13 packets
[*] (1/13) Fingerprint for packet &#39;No route one entry&#39;
[*] (1/13) Fingerprint for packet &#39;No route one entry&#39; not matched
[*] (2/13) Fingerprint for packet &#39;Timeout&#39;
[*] (2/13) Fingerprint for packet &#39;Timeout&#39; not matched
..
..
[*] (13/13) Fingerprint for packet &#39;No route invalid length&#39;
[*] (13/13) Fingerprint for packet &#39;No route invalid length&#39; not matched

[*] Non matched fingerprints (13/13):
[-] Request: No route one entry
[-] Request: Timeout
[-] Request: No route
[-] Request: Empty route invalid offset
[-] Request: Non existent domain old version
[-] Request: Valid domain invalid service
[-] Request: Invalid control opcode
[-] Request: Network packet too big
[-] Request: Empty route invalid length
[-] Request: Non existent domain
[-] Request: Empty route valid length
[-] Request: Empty route null offset
[-] Request: No route invalid length

[-] Some error values where not found in the fingerprint database. If you want to contribute submit a issue to https://github.com/SecureAuthCorp/pysap or write an email to mgallo@secureauth.com with the following information along with the SAP Router file information and how it was configured.


New fingerprint saved to: saprouter_new_fingerprints.json


Version information to complete and submit:
{
    &quot;comment&quot;: &quot;&quot;,
    &quot;submitted_by&quot;: &quot;&quot;,
    &quot;update_level&quot;: &quot;&quot;,
    &quot;patch_number&quot;: &quot;&quot;,
    &quot;file_version&quot;: &quot;&quot;,
    &quot;platform&quot;: &quot;&quot;,
    &quot;source_id&quot;: &quot;&quot;
}
</pre></div>
</div>
<p>In this case, as the information contained in the error messages wasn’t found in the database,
the script output contains the steps and information required to incorporate that version in the
database as a new record. This can be done by using the <code class="docutils literal notranslate"><span class="pre">--add-fingerprint</span></code> option on the script
and providing the <code class="docutils literal notranslate"><span class="pre">json</span></code> record.</p>
<p>The following example command line options can be used to add the missing version number to the
database:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ./router_fingerprint.py -a saprouter_new_fingerprints.json -i &#39;{
&gt;     &quot;comment&quot;: &quot;A new comment to add to the fingerprint&quot;,
&gt;     &quot;submitted_by&quot;: &quot;email or contact of the submitter&quot;,
&gt;     &quot;update_level&quot;: &quot;update level&quot;,
&gt;     &quot;patch_number&quot;: &quot;patch number&quot;,
&gt;     &quot;file_version&quot;: &quot;file vesion&quot;,
&gt;     &quot;platform&quot;: &quot;linux_x86_64&quot;,
&gt;     &quot;source_id&quot;: &quot;source id number&quot;
&gt; }&#39;
[*] Loading fingerprint database
[*] Adding a new entry to the fingerprint database
[*] Added a new entry for the target No route one entry
[*] Added a new entry for the target Timeout
[*] Added a new entry for the target No route
[*] Added a new entry for the target Empty route invalid offset
[*] Added a new entry for the target Non existent domain old version
[*] Added a new entry for the target Valid domain invalid service
[*] Added a new entry for the target Invalid control opcode
[*] Added a new entry for the target Network packet too big
[*] Added a new entry for the target Empty route invalid length
[*] Added a new entry for the target Non existent domain
[*] Added a new entry for the target Empty route valid length
[*] Added a new entry for the target Empty route null offset
[*] Added a new entry for the target No route invalid length
</pre></div>
</div>
<p>Fingerprints for missing versions can be contributed in the form of GitHub issues reporting the
version and build numbers or in the form of pull requests with the addition of new records to the
database.</p>
</div>
<div class="section" id="router-niping">
<h2><code class="docutils literal notranslate"><span class="pre">router_niping</span></code><a class="headerlink" href="#router-niping" title="Permalink to this headline">¶</a></h2>
<p>This example scripts is a very basic implementation of the <code class="docutils literal notranslate"><span class="pre">niping</span></code> tool available with SAP kernel
distributions and the <code class="docutils literal notranslate"><span class="pre">saprouter</span></code> program. The <code class="docutils literal notranslate"><span class="pre">niping</span></code> utility establishes a communication
between two ends (a “client” and a “server”) and uses the <code class="docutils literal notranslate"><span class="pre">NI</span></code> protocol to send payloads. The tool
is offered as a way to perform troubleshooting and network diagnostics, and it can help determining
network speed and identify connectivity issues. Due to the implementation of the <code class="docutils literal notranslate"><span class="pre">NI</span></code> protocol is
also used to validate SAP Router configurations and ACLs.</p>
</div>
<div class="section" id="router-password-check">
<h2><code class="docutils literal notranslate"><span class="pre">router_password_check</span></code><a class="headerlink" href="#router-password-check" title="Permalink to this headline">¶</a></h2>
<p>This example and proof of concept script connects with a SAP Router service and makes an information
request using a provided password. It then records the time the remote service takes to respond to
the request. Further analysis of the time records could be performed in order to identify whether
the server is vulnerable to a timing attack on the password check
(<a class="reference external" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2014-0984">CVE-2014-0984</a>).
More details about the vulnerability can be found in the
<a class="reference external" href="https://www.coresecurity.com/advisories/sap-router-password-timing-attack">SAP Router Password Timing Attack security advisory</a>.</p>
<p>The script make use of the fau_timer library for measuring the timing of server’s responses, which
can be installed from the <a class="reference external" href="https://github.com/seecurity/mona-timing-lib">mona-timing-lib repository in GitHub</a>.</p>
</div>
<div class="section" id="router-portfw">
<h2><code class="docutils literal notranslate"><span class="pre">router_portfw</span></code><a class="headerlink" href="#router-portfw" title="Permalink to this headline">¶</a></h2>
<p>This example script establishes a connection to a target host and port through a SAP Router service.
It works by binding a local port (specified by <code class="docutils literal notranslate"><span class="pre">--local-port</span></code>) on a local IP address (provided by
<code class="docutils literal notranslate"><span class="pre">--local-host</span></code>) and requesting the SAP Router (specified with <code class="docutils literal notranslate"><span class="pre">--remote-host</span></code> and <code class="docutils literal notranslate"><span class="pre">--remote-port</span></code>)
to route a connection to the specified target port (<code class="docutils literal notranslate"><span class="pre">--target-port</span></code>) and host (<code class="docutils literal notranslate"><span class="pre">--target-host</span></code>).
A route password can be optionally provided as well (with the <code class="docutils literal notranslate"><span class="pre">--target-pass</span></code> parameter).</p>
<p>The script can be used to route traffic to a remote destination through the SAP Router, for either
testing ACLs or accessing internal resources exposed through it. It’s worth mentioning that as the
implementation relies on the use of a “proxy” pattern, the route is only requested to the SAP Router
when there’s traffic received on the local port binded.</p>
<p>The script is based on a similar functionality implemented in BizPloit’s <code class="docutils literal notranslate"><span class="pre">saprouterNative</span></code> script.
More information can be found in Onapsis’ blogpost series about testing SAP Router security with
BizPloit, <a class="reference external" href="https://blog.onapsis.com/blog/assessing-a-saprouters-security-with-onapsis-bizploit-part-i/">part I</a>
and <a class="reference external" href="https://blog.onapsis.com/blog/assessing-a-saprouters-security-with-onapsis-bizploit-part-ii/">part II</a>.</p>
</div>
<div class="section" id="router-scanner">
<h2><code class="docutils literal notranslate"><span class="pre">router_scanner</span></code><a class="headerlink" href="#router-scanner" title="Permalink to this headline">¶</a></h2>
<p>This example script performs a scan of a given set of target hosts (specified with <code class="docutils literal notranslate"><span class="pre">--target-hosts</span></code>)
and ports (provided with <code class="docutils literal notranslate"><span class="pre">--target-ports</span></code>) via a SAP Router instance (specified with <code class="docutils literal notranslate"><span class="pre">--remote-host</span></code>
and <code class="docutils literal notranslate"><span class="pre">--remote-port</span></code>). By requesting a connection to be routed to a given host/port combination and
looking to the SAP Router response, it’s possible to determine if the aforementioned host/port is open
to the SAP Router. The script can be also used to discover and validate ACLs configured in the SAP
Router instance.</p>
<p>The list of hosts can be provided to the <code class="docutils literal notranslate"><span class="pre">--target-hosts</span></code> parameter as a comma-separated list of
hostnames or IP addresses (e.g. <code class="docutils literal notranslate"><span class="pre">10.0.0.1,10.0.0.10</span></code>), or if the Python’s <code class="docutils literal notranslate"><span class="pre">netaddr</span></code> library is
installed in <code class="docutils literal notranslate"><span class="pre">CIDR</span></code> representation (e.g. <code class="docutils literal notranslate"><span class="pre">10.0.0.1/24</span></code>). In the same way, the ports to scan for
can be provided in the <code class="docutils literal notranslate"><span class="pre">--target-ports</span></code> parameter using a commma-separated list (e.g. <code class="docutils literal notranslate"><span class="pre">3200,3300</span></code>)
or a range (e.g. <code class="docutils literal notranslate"><span class="pre">3200-3299</span></code>).</p>
<p>The script is based on a similar functionality implemented in BizPloit’s <code class="docutils literal notranslate"><span class="pre">saprouterSpy</span></code> script.
More information can be found in Onapsis’ blogpost series about testing SAP Router security with
BizPloit, <a class="reference external" href="https://blog.onapsis.com/blog/assessing-a-saprouters-security-with-onapsis-bizploit-part-i/">part I</a>
and <a class="reference external" href="https://blog.onapsis.com/blog/assessing-a-saprouters-security-with-onapsis-bizploit-part-ii/">part II</a>.</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">pysap</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">User guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../protocols/index.html">Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fileformats/index.html">File formats</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Example scripts</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="diag.html">Diag Example scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="dlmanager.html">Download Manager scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="enqueue.html">Enqueue Example scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="gw.html">Gateway Example scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="igs.html">Internet Graphic Service Example scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="message_server.html">Message Server Example scripts</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Router Example scripts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#router-admin"><code class="docutils literal notranslate"><span class="pre">router_admin</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#router-fingerprint"><code class="docutils literal notranslate"><span class="pre">router_fingerprint</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#router-niping"><code class="docutils literal notranslate"><span class="pre">router_niping</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#router-password-check"><code class="docutils literal notranslate"><span class="pre">router_password_check</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#router-portfw"><code class="docutils literal notranslate"><span class="pre">router_portfw</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#router-scanner"><code class="docutils literal notranslate"><span class="pre">router_scanner</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">Developer Interface</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Example scripts</a><ul>
      <li>Previous: <a href="message_server.html" title="previous chapter">Message Server Example scripts</a></li>
      <li>Next: <a href="../dev/index.html" title="next chapter">Development</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;SECUREAUTH LABS. Copyright (C) 2019 SecureAuth Corporation. All rights reserved..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.9</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/examples/router.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>